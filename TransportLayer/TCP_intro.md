# 연결지향형 트랜스포트: TCP

TCP는 신뢰적인 데이터 전송을 제공하기 위해 오류 검출, 재전송, 누적확인응답, 타이머, 순서번호와 확인응답 번호를 위한 헤더 필드를 포함하여 앞에서 논의했던 원칙들을 따르고 있다.  


## TCP 연결

TCP는 애플리케이션 프로세스가 데이터를 다른 프로세스로 보내기 전에 두 프로세스가 서로 '핸드셰이크'를 먼저 해야하므로 연결지향형이다.  
즉, 데이터 전송을 보정하는 파라미터들을 각자 설정하기 위한 어떤 사전 세그먼트들을 보내야한다.  

TCP 연결은 두 통신 종단 시스템의 TCP에 존재하는 상태를 공유하는 논리적인 것이다.  
오직 종단 시스템에서만 작동하고 중간의 네트워크 요소에서는 동작하지 않으므로 중간의 네트워크 요소들은 TCP 연결 상태를 유지하지 않는다.  

TCP 연결은 전이중 서비스를 제공한다.  
만약 호스트 A의 프로세스와 호스트B의 프로세스 사이에 TCP 연결이 있다면 애플리케이션 계층 데이터는 B에서 A로 흐르는 동시에 A에서 B로 흐를 수 있다.  

TCP 연결은 항상 단일 송신자와 단일 수신자 사이의 점대점이다.  
단일 송신 동작으로 한 송신자가 여러 수신자에게 데이터를 전송하는 멀티태스킹은 TCP에서 불가능하다.  

연결을 초기화하는 프로세스를 클라이언트 프로세스, 다른 프로세스를 서버 프로세스라고 한다.  

클라이언트가 특별한 TCP 세그먼트를 보낸다. 서버는 두 번째 특별한 TCP 세그먼트로 응답한다. 마지막으로 클라이언트가 세 번째 특별한 세그먼트로 다시 응답한다.  

처음 두 개의 세그먼트에는 페이로드 즉, 애플리케이션 계층이 없다.  
세 번째 세그먼트는 페이로드를 포함할 수 있다.  
두 호스트 사이에 3개의 세그먼트가 보내지므로 이 연결 설정 절차를 세 방향 핸드셰이크라고 한다.  

TCP는 초기 세 방향 핸드셰이크 동안 준비된 버퍼중의 하나인 연결의 송신 버퍼로 데이터를 보낸다.  
때때로 TCP는 송신 버퍼에서 데이터 묶음을 만들어서 네트워크로 보낸다.  

세그먼트로 모아 담을 수 있는 최대 데이터의 양은 최대 세그먼트 크기(MSS)로 제한된다.  
MSS는 일반적으로 로컬 송신 호스트에 의해 전송될 수 있는 가장 큰 링크 계층 프레임의 길이(최대 전송 단위, MTU)에 의해 일단 결정되고 그런 후에 TCP 세그먼트(데이터그램 캡슐화)와 TCP/IP 헤더 길의 (통상 40바이트)가 단일 링크 계층 프레임에 딱 맞도록 하여 정해진다.  

이더넷과 PPP 링크 계층 프로토콜은 모두 1500바이트의 MTU를 갖는다.  
따라서 MSS의 일반적인 값은 1460바이트이다.

MSS가 헤더를 포함하는 TCP 세그먼트의 최대 크기가 아니라. 세그먼트에 있는 애플리케이션 계층의 최대 크기라는 점을 주의하자.  

TCP가 상대에게서 세그먼트를 수신했을 때, 세그먼트의 데이터는 TCP 연결의 수신 버퍼에 위치한다.  
애플리케이션은 이버퍼로부터 데이터스트림을 읽는다. 연결의 양 끝은 각각 자신의 송신 버퍼와 수신 버퍼를 갖고 있다.  


## TCP 세그먼트 구조

TCP 세그먼트는 헤더 필드와 데이터 필드로 구성되어 있다.  
MSS는 세그먼트 데이터 필드의 크기를 제한한다. TCP가 웹 문서의 이미지와 같은 큰 파일을 전송할 때, 일반적으로 MSS크기로 파일을 분절한다. (마지막 분절은 제외)  

|                    16비트                     |  16비트  |
| :-------------------------------------------: | :----------------: |
|               출발지 포트 번호                |  목적지 포트 번호  |
|                   순서 번호                   |                    |
|                 확인응답 번호                 |                    |
| 헤더길이, x , CWR,ECE,URG,ACK,PSH,RST,SYN,FIN |     수신 윈도      |
|                 인터넷 체크섬                 | 긴급 데이터 포인터 |
|                     옵션                      |                    |
|           애플리케이션 계층 데이터            |                    |


TCP 헤더는 출발지와 목적지 포트번호, 체크섬 필드, 32비트 순서번호 필드와 32비트 확인응답 번호 필드를 가진다.  
16비트 수신 윈도 필드는 흐름제어에 사용된다. 사용자가 받아들이려는 바이트의 크기를 나타내는데 사용된다.  
4비트 헤더 길이 필드는 32비트 워드 단위로 TCP 헤더의 길이를 나타낸다. TCP옵션 필드 때문에 가변적일 수 있다.  
플래그 비트는 6비트를 포함한다.  
ACK 비트는 확인응답 필드에 있는 값이 유용함을 가르킨다. 즉, 이 세그먼트는 성공적으로 수신된 세그먼트에 대한 확인응답을 포함한다.  
RST, SYN, FIN 비트는 연결 설정과 해제에 사용된다.  


## 정리 및 요약

TCP는 세 방향 핸드셰이크를 통해 연결을 하는 연결지향형 프로토콜이다.  
앞의 두번의 연결은 애플리케이션 계층 데이터를 포함하지 않지만 마지막 세그먼트는 애플리케이션 계층 데이터를 가질 수 있다.  

MSS는 세그먼트 안의 애플리케이션 계층 데이터의 최대 크기이다.  

연결을 통해 송신자와 수신자는 각각 자신의 송신 버퍼와 수신 버퍼를 갖는다. 이는 TCP 프로토콜이 전이중 연결이기 때문에 서로가 서로에게 데이터를 전송할 수 있다.  

TCP 세그먼트의 헤더는 총 20바이트이며 길이는 32비트이다.  
출발지 포트번호, 목적지 포트번호는 역다중화에 사용하고
순서번호, 확인응답 번호, ACK 플래그 비트, 체크섬은 신뢰적 데이터 전송 서비스를 제공하는데 사용된다.  
수신윈도는 흐름제어에 사용되며 송신자의 전송량을 제한한다.  

RST, SYN, FIN 플래그 비트는 TCP 연결설정에 사용되는 비트이다.  





